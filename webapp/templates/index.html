<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF ä¹¦ç­¾æ³¨å…¥å·¥å…·</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body { background: #f0f2f5; }
    .card { border: none; border-radius: 12px; box-shadow: 0 2px 16px rgba(0,0,0,.08); }

    /* â”€â”€â”€ æ‹–æ‹½åŒº â”€â”€â”€ */
    #drop-zone {
      border: 2.5px dashed #adb5bd;
      border-radius: 10px;
      padding: 44px 24px;
      text-align: center;
      cursor: pointer;
      transition: border-color .2s, background .2s;
      background: #fff;
    }
    #drop-zone.drag-over { border-color: #0d6efd; background: #e8f0fe; }
    #drop-zone .icon { font-size: 2.8rem; }
    #drop-zone .hint { color: #6c757d; margin-top: 8px; font-size: .93rem; }
    #drop-zone .fname { margin-top: 10px; font-weight: 600; color: #0d6efd; word-break: break-all; }

    /* â”€â”€â”€ é¡µé¢é€‰æ‹©å™¨ â”€â”€â”€ */
    #page-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(88px, 1fr));
      gap: 8px;
      max-height: 390px;
      overflow-y: auto;
      padding: 4px 2px;
    }
    .pg-card {
      position: relative;
      cursor: pointer;
      border: 2.5px solid #dee2e6;
      border-radius: 7px;
      overflow: hidden;
      background: #e9ecef;
      transition: border-color .15s, box-shadow .15s;
      user-select: none;
    }
    .pg-card:hover { border-color: #90caf9; }
    .pg-card.selected {
      border-color: #0d6efd;
      box-shadow: 0 0 0 2px rgba(13,110,253,.22);
    }
    .pg-card img { width: 100%; display: block; min-height: 50px; }
    .pg-card .pg-num {
      text-align: center; font-size: .65rem; color: #555;
      padding: 2px 0 3px; background: #fff;
    }
    .pg-card .pg-check {
      display: none; position: absolute; top: 4px; right: 4px;
      background: #0d6efd; color: #fff;
      border-radius: 50%; width: 20px; height: 20px;
      line-height: 20px; text-align: center; font-size: .72rem; font-weight: 700;
    }
    .pg-card.selected .pg-check { display: block; }

    /* â”€â”€â”€ æ­¥éª¤å¾½ç«  â”€â”€â”€ */
    .step-badge {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 4px 10px; border-radius: 20px; font-size: .78rem;
      background: #e9ecef; color: #6c757d; transition: background .3s, color .3s;
      white-space: nowrap;
    }
    .step-badge.active { background: #0d6efd; color: #fff; }
    .step-badge.done   { background: #198754; color: #fff; }
    .step-arrow { color: #adb5bd; font-size: .8rem; }

    /* â”€â”€â”€ æ—¥å¿—åŒº â”€â”€â”€ */
    #log-area {
      background: #1e1e1e; color: #d4d4d4;
      font-family: 'Consolas', 'Courier New', monospace;
      font-size: .77rem; line-height: 1.5;
      padding: 12px 14px; border-radius: 8px;
      height: 230px; overflow-y: auto;
      white-space: pre-wrap; word-break: break-all;
    }
    .log-step  { color: #4fc3f7; font-weight: 600; }
    .log-error { color: #ef9a9a; font-weight: 600; }

    #cur-step-msg { font-size: .83rem; color: #6c757d; min-height: 1.2em; }
  </style>
</head>
<body>
<div class="container py-5" style="max-width: 680px;">
  <h2 class="mb-4 fw-bold">PDF ä¹¦ç­¾æ³¨å…¥å·¥å…·</h2>

  <!-- â•â•â• çŠ¶æ€ 1ï¼šä¸Šä¼  â•â•â• -->
  <div id="s-upload" class="card p-4">
    <div id="drop-zone">
      <div class="icon">ğŸ“„</div>
      <div class="hint">æ‹–æ‹½ PDF åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
      <div id="fname" class="fname" hidden></div>
    </div>
    <input type="file" id="file-input" accept=".pdf" hidden>

    <div class="mt-3">
      <label for="token-input" class="form-label small text-muted mb-1">
        MinerU API Token
        <a href="https://mineru.net/apiManage/token" target="_blank"
           class="ms-1 text-muted" style="font-size:.8em;">ï¼ˆè·å– Tokenï¼‰</a>
      </label>
      <input type="password" id="token-input" class="form-control form-control-sm"
             placeholder="eyJ..." autocomplete="off">
    </div>

    <button id="btn-upload" class="btn btn-primary mt-3 w-100" disabled>
      ä¸Šä¼ å¹¶é€‰æ‹©ç›®å½•é¡µ
    </button>
    <div id="upload-err" class="alert alert-danger mt-3 py-2" hidden></div>
  </div>

  <!-- â•â•â• çŠ¶æ€ 2ï¼šç›®å½•é¡µé€‰æ‹© â•â•â• -->
  <div id="s-select" class="card p-4" hidden>
    <div class="d-flex align-items-center justify-content-between mb-1">
      <h5 class="mb-0">é€‰æ‹©ç›®å½•é¡µé¢</h5>
      <!-- æ£€æµ‹çŠ¶æ€å¾½ç«  -->
      <div id="detect-badge" class="d-flex align-items-center gap-2">
        <span id="detect-spinner"
              class="spinner-border spinner-border-sm text-primary"
              role="status" aria-label="æ£€æµ‹ä¸­"></span>
        <small id="detect-txt" class="text-muted">è‡ªåŠ¨æ£€æµ‹ä¸­...</small>
      </div>
    </div>
    <p class="text-muted small mb-2">
      ç‚¹å‡»é¡µé¢ç¼©ç•¥å›¾é€‰ä¸­/å–æ¶ˆï¼ˆå¯å¤šé€‰ï¼‰ã€‚è“è‰²è¾¹æ¡† = å·²é€‰ä¸­ã€‚
    </p>

    <div id="page-grid" class="mb-2"></div>

    <div id="load-more-wrap" class="text-center mb-3" hidden>
      <button id="btn-load-more" class="btn btn-outline-secondary btn-sm">
        åŠ è½½æ›´å¤šé¡µé¢ â€º
      </button>
    </div>

    <div class="d-flex align-items-center flex-wrap gap-2">
      <button id="btn-confirm" class="btn btn-primary">
        å¼€å§‹å¤„ç†&nbsp;
        <span id="sel-count" class="badge bg-white text-primary">0 é¡µå·²é€‰</span>
      </button>
      <button id="btn-clear" class="btn btn-outline-secondary btn-sm">æ¸…é™¤é€‰æ‹©</button>
      <button id="btn-back"  class="btn btn-link btn-sm text-muted ms-auto">â† é‡æ–°ä¸Šä¼ </button>
    </div>
    <div id="select-err" class="alert alert-danger mt-3 py-2" hidden></div>
  </div>

  <!-- â•â•â• çŠ¶æ€ 3ï¼šå¤„ç†è¿›åº¦ â•â•â• -->
  <div id="s-progress" class="card p-4" hidden>
    <div class="d-flex flex-wrap gap-1 align-items-center mb-3" id="steps-row">
      <span class="step-badge" data-step="1">â‘ &nbsp;æå–ç›®å½•</span>
      <span class="step-arrow">â€º</span>
      <span class="step-badge" data-step="2">â‘¡&nbsp;OCR</span>
      <span class="step-arrow">â€º</span>
      <span class="step-badge" data-step="3">â‘¢&nbsp;æ³¨å…¥ä¹¦ç­¾</span>
      <span class="step-arrow">â€º</span>
      <span class="step-badge" data-step="4">â‘£&nbsp;æ¡æ–‡è¯´æ˜</span>
      <span class="step-arrow">â€º</span>
      <span class="step-badge" data-step="5">â‘¤&nbsp;OCR</span>
      <span class="step-arrow">â€º</span>
      <span class="step-badge" data-step="6">â‘¥&nbsp;å­ä¹¦ç­¾</span>
    </div>

    <div class="progress mb-1" style="height:22px;">
      <div id="prog-bar"
           class="progress-bar progress-bar-striped progress-bar-animated"
           role="progressbar" style="width:2%;min-width:2em;">0%</div>
    </div>
    <div id="cur-step-msg" class="mb-2">å‡†å¤‡ä¸­...</div>
    <!-- æ¡æ–‡è¯´æ˜ç›®å½•é€‰æ‹©é¢æ¿ï¼ˆstep3 å®Œæˆåå†…åµŒæ˜¾ç¤ºï¼‰ -->
    <div id="clause-panel" class="border border-primary rounded p-3 mb-3 bg-white" hidden>
      <div class="d-flex align-items-center mb-1 gap-2">
        <span style="font-size:1.3rem;">ğŸ“‘</span>
        <strong>æ˜¯å¦æ·»åŠ æ¡æ–‡è¯´æ˜å­ç›®å½•ä¹¦ç­¾ï¼Ÿ</strong>
      </div>
      <p class="small text-muted mb-2">
        é€‰æ‹©æ¡æ–‡è¯´æ˜çš„ç›®å½•é¡µï¼ˆé€šå¸¸åœ¨æ¡æ–‡è¯´æ˜æ ‡é¢˜é¡µå 1â€“3 é¡µï¼‰ï¼Œæˆ–ç‚¹å‡»"è·³è¿‡"ç›´æ¥å®Œæˆã€‚
      </p>
      <div id="clause-grid"
           style="display:grid;grid-template-columns:repeat(auto-fill,minmax(88px,1fr));
                  gap:8px;max-height:220px;overflow-y:auto;" class="mb-2"></div>
      <div class="d-flex gap-2 flex-wrap">
        <button id="btn-clause-confirm" class="btn btn-primary btn-sm">
          æ·»åŠ å­ç›®å½•&nbsp;<span id="clause-count" class="badge bg-white text-primary">0 é¡µ</span>
        </button>
        <button id="btn-clause-skip" class="btn btn-outline-secondary btn-sm">è·³è¿‡ï¼Œä¸æ·»åŠ </button>
      </div>
    </div>

    <div id="log-area"></div>
    <div id="prog-err" class="alert alert-danger mt-3 py-2" hidden></div>
  </div>

  <!-- â•â•â• çŠ¶æ€ 4ï¼šå®Œæˆ â•â•â• -->
  <div id="s-done" class="card p-4 text-center" hidden>
    <div style="font-size:3.5rem;">âœ…</div>
    <h4 id="done-msg" class="mt-2 mb-3"></h4>
    <div class="d-flex justify-content-center gap-3">
      <a id="btn-dl" href="#" class="btn btn-success px-4">â¬‡&nbsp;ä¸‹è½½ PDF</a>
      <button id="btn-reset" class="btn btn-outline-secondary px-4">å¤„ç†å¦ä¸€ä¸ªæ–‡ä»¶</button>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// å·¥å…·
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $  = id => document.getElementById(id);
const show = id => { $(id).hidden = false; };
const hide = id => { $(id).hidden = true;  };
const sleep = ms => new Promise(r => setTimeout(r, ms));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// å…¨å±€çŠ¶æ€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let jobId       = null;
let totalPages  = 0;
let shownPages  = 0;       // å·²æ¸²æŸ“çš„ç¼©ç•¥å›¾æ•°
let selPages    = new Set(); // å·²é€‰é¡µé¢ï¼ˆ0-indexedï¼‰
const PAGE_BATCH = 25;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// çŠ¶æ€åˆ‡æ¢
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showUpload() {
  hide('s-select'); hide('s-progress'); hide('s-done');
  show('s-upload');
}
function showSelect() {
  hide('s-upload'); hide('s-progress'); hide('s-done');
  show('s-select');
}
function showProgress() {
  hide('s-upload'); hide('s-select'); hide('s-done');
  show('s-progress');
  $('log-area').innerHTML = '';
  $('cur-step-msg').textContent = 'æ­£åœ¨å¯åŠ¨...';
  setProgress(0);
}
function showDone(msg) {
  hide('s-progress');
  show('s-done');
  $('done-msg').textContent = msg;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ä¸Šä¼ åŒº
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedFile = null;
const dropZone = $('drop-zone');
const fileInput = $('file-input');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.classList.remove('drag-over');
  if (e.dataTransfer.files[0]) setFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', () => { if (fileInput.files[0]) setFile(fileInput.files[0]); });

function setFile(f) {
  if (!f.name.toLowerCase().endsWith('.pdf')) {
    showErr('upload-err', 'è¯·é€‰æ‹© .pdf æ–‡ä»¶');
    return;
  }
  selectedFile = f;
  $('fname').textContent = f.name;
  $('fname').hidden = false;
  $('btn-upload').disabled = false;
  hide('upload-err');
}

$('btn-upload').addEventListener('click', async () => {
  if (!selectedFile) return;
  $('btn-upload').disabled = true;
  $('btn-upload').textContent = 'ä¸Šä¼ ä¸­...';

  const fd = new FormData();
  fd.append('file', selectedFile);
  let data;
  try {
    const res = await fetch('/upload', { method: 'POST', body: fd });
    data = await res.json();
    if (!res.ok) throw new Error(data.error || 'ä¸Šä¼ å¤±è´¥');
  } catch (e) {
    showErr('upload-err', e.message);
    $('btn-upload').disabled = false;
    $('btn-upload').textContent = 'ä¸Šä¼ å¹¶é€‰æ‹©ç›®å½•é¡µ';
    return;
  }

  jobId      = data.job_id;
  totalPages = data.total_pages;
  selPages   = new Set();
  shownPages = 0;

  // é‡ç½®é€‰æ‹©ç•Œé¢
  $('page-grid').innerHTML = '';
  hide('select-err');
  $('detect-spinner').hidden = false;
  $('detect-txt').textContent = 'è‡ªåŠ¨æ£€æµ‹ä¸­...';
  $('detect-txt').className = 'text-muted';

  showSelect();
  renderBatch();         // æ¸²æŸ“é¦–æ‰¹ç¼©ç•¥å›¾
  pollDetect();          // å¯åŠ¨åå°æ£€æµ‹è½®è¯¢
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ç¼©ç•¥å›¾æ¸²æŸ“
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBatch() {
  const end = Math.min(shownPages + PAGE_BATCH, totalPages);
  for (let i = shownPages; i < end; i++) addThumb(i);
  shownPages = end;

  // æ˜¾ç¤º/éšè—"åŠ è½½æ›´å¤š"æŒ‰é’®
  if (shownPages < totalPages) {
    $('btn-load-more').textContent = `åŠ è½½æ›´å¤šé¡µé¢ï¼ˆç¬¬${shownPages+1}é¡µèµ·ï¼‰â€º`;
    show('load-more-wrap');
  } else {
    hide('load-more-wrap');
  }
}

function addThumb(pageNum) {
  const card = document.createElement('div');
  card.className = 'pg-card';
  card.dataset.page = pageNum;
  card.innerHTML = `
    <img src="/thumbnail/${jobId}/${pageNum}" alt="ç¬¬${pageNum+1}é¡µ" loading="lazy">
    <div class="pg-num">ç¬¬ ${pageNum+1} é¡µ</div>
    <div class="pg-check">âœ“</div>`;
  card.addEventListener('click', () => togglePage(pageNum));
  $('page-grid').appendChild(card);
}

$('btn-load-more').addEventListener('click', renderBatch);

function togglePage(n) {
  if (selPages.has(n)) selPages.delete(n);
  else selPages.add(n);
  refreshCard(n);
  updateSelCount();
}

function refreshCard(n) {
  const c = document.querySelector(`.pg-card[data-page="${n}"]`);
  if (c) c.classList.toggle('selected', selPages.has(n));
}

function updateSelCount() {
  const n = selPages.size;
  $('sel-count').textContent = n + (n === 1 ? ' é¡µå·²é€‰' : ' é¡µå·²é€‰');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// è‡ªåŠ¨æ£€æµ‹è½®è¯¢
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pollDetect() {
  for (let i = 0; i < 120; i++) {   // æœ€å¤šç­‰ 3 åˆ†é’Ÿ
    await sleep(1500);
    try {
      const res  = await fetch(`/detect/${jobId}`);
      const data = await res.json();
      if (data.status === 'done') {
        // é¢„é€‰æ£€æµ‹åˆ°çš„é¡µé¢
        (data.pages || []).forEach(p => {
          selPages.add(p);
          refreshCard(p);          // å·²æ¸²æŸ“çš„ç›´æ¥æ›´æ–°ï¼›æœªæ¸²æŸ“çš„åœ¨æ¸²æŸ“æ—¶ä¹Ÿä¼šå¤„ç†
        });
        updateSelCount();
        $('detect-spinner').hidden = true;
        const n = (data.pages || []).length;
        $('detect-txt').textContent = n ? `è‡ªåŠ¨æ£€æµ‹åˆ° ${n} ä¸ªç›®å½•é¡µ` : 'æœªæ£€æµ‹åˆ°ç›®å½•é¡µï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©';
        $('detect-txt').className = n ? 'text-success fw-bold small' : 'text-warning fw-bold small';
        return;
      }
    } catch { /* å¿½ç•¥ç½‘ç»œæŠ–åŠ¨ */ }
  }
  // è¶…æ—¶
  $('detect-spinner').hidden = true;
  $('detect-txt').textContent = 'æ£€æµ‹è¶…æ—¶ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©';
  $('detect-txt').className = 'text-warning small';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ç¡®è®¤é¡µé¢é€‰æ‹©ï¼Œå¯åŠ¨æµæ°´çº¿
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btn-confirm').addEventListener('click', async () => {
  hide('select-err');
  if (selPages.size === 0) { showErr('select-err', 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç›®å½•é¡µ'); return; }

  showProgress();

  const toc_pages  = Array.from(selPages).sort((a, b) => a - b);
  const api_token  = $('token-input').value.trim();
  await fetch(`/start/${jobId}`, {
    method:  'POST',
    headers: { 'Content-Type': 'application/json' },
    body:    JSON.stringify({ toc_pages, api_token }),
  });

  listenProgress(jobId);
});

$('btn-clear').addEventListener('click', () => {
  selPages.forEach(n => refreshCard(n));
  selPages.clear();
  updateSelCount();
});

$('btn-back').addEventListener('click', () => {
  showUpload();
  $('btn-upload').disabled  = false;
  $('btn-upload').textContent = 'ä¸Šä¼ å¹¶é€‰æ‹©ç›®å½•é¡µ';
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SSE è¿›åº¦ç›‘å¬
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setProgress(pct) {
  const bar = $('prog-bar');
  bar.style.width   = Math.max(pct, 2) + '%';
  bar.textContent   = pct + '%';
}

function setStepActive(step) {
  document.querySelectorAll('.step-badge').forEach(el => {
    const s = parseInt(el.dataset.step);
    el.className = 'step-badge' + (s < step ? ' done' : s === step ? ' active' : '');
  });
}

function appendLog(text, cls) {
  const log  = $('log-area');
  const line = document.createElement('p');
  line.className = cls ? cls : '';
  line.style.margin = '0';
  line.textContent = text;
  log.appendChild(line);
  log.scrollTop = log.scrollHeight;
}

function listenProgress(jid) {
  const es = new EventSource(`/progress/${jid}`);
  es.onmessage = evt => {
    let d; try { d = JSON.parse(evt.data); } catch { return; }

    if      (d.type === 'step_start') {
      if (d.step     != null) setStepActive(d.step);
      if (d.progress != null) setProgress(d.progress);
      if (d.msg)              $('cur-step-msg').textContent = d.msg;
      appendLog('â–¶ ' + d.msg, 'log-step');
    }
    else if (d.type === 'log')          { appendLog(d.msg); }
    else if (d.type === 'select_clause') {
      if (d.progress != null) setProgress(d.progress);
      $('cur-step-msg').textContent = 'ç­‰å¾…ç”¨æˆ·ç¡®è®¤æ¡æ–‡è¯´æ˜è®¾ç½®...';
      appendLog('ğŸ“‘ ' + d.msg, 'log-step');
      showClausePanel(d.clause_page);
    }
    else if (d.type === 'done')  {
      setProgress(100);
      document.querySelectorAll('.step-badge').forEach(el => el.className = 'step-badge done');
      appendLog('âœ… ' + d.msg, 'log-step');
      es.close();
      setTimeout(() => {
        $('btn-dl').href = `/download/${jid}`;
        showDone(d.msg);
      }, 700);
    }
    else if (d.type === 'error') {
      appendLog('âŒ ' + d.msg, 'log-error');
      showErr('prog-err', d.msg);
      es.close();
    }
    else if (d.type === 'end')   { es.close(); }
    // heartbeat: å¿½ç•¥
  };
  es.onerror = () => {
    appendLog('âš  SSE è¿æ¥æ–­å¼€ï¼Œå¤„ç†å¯èƒ½ä»åœ¨åå°è¿è¡Œ', 'log-error');
    es.close();
  };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// é‡ç½®
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btn-reset').addEventListener('click', () => {
  selectedFile = null;
  fileInput.value = '';
  $('fname').hidden = true;
  $('btn-upload').disabled  = true;
  $('btn-upload').textContent = 'ä¸Šä¼ å¹¶é€‰æ‹©ç›®å½•é¡µ';
  hide('upload-err');
  document.querySelectorAll('.step-badge').forEach(el => el.className = 'step-badge');
  showUpload();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// æ¡æ–‡è¯´æ˜ç›®å½•é€‰æ‹©é¢æ¿
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let clauseSel = new Set();

function showClausePanel(startPage0) {
  clauseSel = new Set();
  $('clause-count').textContent = '0 é¡µ';
  $('clause-grid').innerHTML = '';

  // ä» startPage0ï¼ˆ0-indexedï¼‰å¼€å§‹å±•ç¤ºçº¦ 20 é¡µ
  const start = (startPage0 != null && startPage0 >= 0)
                  ? startPage0 : Math.max(0, Math.floor(totalPages * 0.6));
  const end = Math.min(start + 20, totalPages);
  for (let i = start; i < end; i++) addClauseThumb(i);

  show('clause-panel');
  // åœæ­¢è¿›åº¦æ¡åŠ¨ç”»ï¼Œè¡¨ç¤ºç­‰å¾…ç”¨æˆ·
  $('prog-bar').classList.remove('progress-bar-animated');
}

function addClauseThumb(n) {
  const card = document.createElement('div');
  card.className = 'pg-card';
  card.dataset.page = n;
  card.innerHTML = `
    <img src="/thumbnail/${jobId}/${n}" alt="ç¬¬${n+1}é¡µ" loading="lazy">
    <div class="pg-num">ç¬¬ ${n+1} é¡µ</div>
    <div class="pg-check">âœ“</div>`;
  card.addEventListener('click', () => {
    if (clauseSel.has(n)) clauseSel.delete(n); else clauseSel.add(n);
    card.classList.toggle('selected', clauseSel.has(n));
    $('clause-count').textContent = clauseSel.size + ' é¡µ';
  });
  $('clause-grid').appendChild(card);
}

async function submitClause(pages) {
  hide('clause-panel');
  $('prog-bar').classList.add('progress-bar-animated');
  $('cur-step-msg').textContent = pages ? 'ç»§ç»­å¤„ç†æ¡æ–‡è¯´æ˜...' : 'è·³è¿‡æ¡æ–‡è¯´æ˜ï¼Œæ”¶å°¾ä¸­...';
  await fetch(`/start_clause/${jobId}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ clause_pages: pages }),
  });
}

$('btn-clause-confirm').addEventListener('click', () => {
  const pages = Array.from(clauseSel).sort((a, b) => a - b);
  submitClause(pages.length > 0 ? pages : null);
});
$('btn-clause-skip').addEventListener('click', () => submitClause(null));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// å·¥å…·ï¼šæ˜¾ç¤ºé”™è¯¯æç¤º
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showErr(id, msg) {
  const el = $(id); el.textContent = msg; el.hidden = false;
}
</script>
</body>
</html>
